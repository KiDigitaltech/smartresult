<!DOCTYPE html>
<html lang="sw">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wastani wa Masomo - SmartResult</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      min-height: 100vh;
      background: #f8f9fa;
    }

    /* Sidebar */
    #sidebar-container {
      width: 220px;
      background: #343a40;
      color: white;
      min-height: 100vh;
      padding: 1rem;
      box-sizing: border-box;
    }

    /* Main content */
    #main-content {
      flex: 1;
      padding: 1rem 1.5rem;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    h1 {
      text-align: center;
      color: #007bff;
      margin-bottom: 1rem;
    }

    .filters {
      display: flex;
      justify-content: center;
      gap: 1rem;
      flex-wrap: wrap;
      margin-bottom: 1rem;
    }

    select {
      padding: 8px 12px;
      font-size: 1rem;
    }

    button {
      padding: 10px 16px;
      font-size: 1rem;
      border-radius: 5px;
      border: none;
      cursor: pointer;
      background-color: #007bff;
      color: white;
      margin: 0 auto 1rem auto;
      display: block;
    }
    button:disabled {
      background-color: #aaa;
      cursor: not-allowed;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      table-layout: fixed;
      box-shadow: 0 0 5px rgb(0 0 0 / 0.1);
    }

    th, td {
      border: 1px solid #ccc;
      padding: 8px 12px;
      font-size: 1rem;
      text-align: center;
      word-wrap: break-word;
    }
    th.subject-name,
    td.subject-name {
      text-align: left;
      white-space: nowrap;
    }

    th {
      background: #f0f0f0;
      font-weight: 700;
      vertical-align: middle;
    }

    /* Grade Colors */
    .grade-A { background-color: #c8e6c9; }  /* green */
    .grade-B { background-color: #bbdefb; }  /* blue */
    .grade-C { background-color: #fff9c4; }  /* yellow */
    .grade-D { background-color: #ffe0b2; }  /* orange */
    .grade-F { background-color: #ffcdd2; }  /* red */

    /* Pie Chart container */
    #chart-container {
      max-width: 450px;
      margin: 2rem auto 1rem auto;
      background: white;
      padding: 1rem;
      border-radius: 6px;
      box-shadow: 0 0 8px rgb(0 0 0 / 0.1);
    }

    /* Print header/footer */
    #print-header, #print-footer {
      text-align: center;
      font-family: 'Times New Roman', serif;
      margin-bottom: 1rem;
      font-size: 1.1rem;
    }
    #print-footer {
      margin-top: 2rem;
      font-size: 0.9rem;
      color: #555;
    }

    /* Loader */
    #loader {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255,255,255,0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      font-size: 1.2rem;
      color: #007bff;
      display: none;
    }
    #loader.active {
      display: flex;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    #loader .spinner {
      border: 5px solid #ddd;
      border-top: 5px solid #007bff;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      margin-right: 12px;
      animation: spin 1s linear infinite;
    }

    /* Print styles */
    @media print {
      body * {
        visibility: hidden;
      }
      #print-area, #print-area * {
        visibility: visible;
      }
      #print-area {
        position: absolute;
        left: 0; top: 0;
        width: 100%;
        padding: 1rem;
      }
      table {
        width: 100% !important;
        border: 1px solid black !important;
        border-collapse: collapse !important;
      }
      th, td {
        border: 1px solid black !important;
        font-family: 'Times New Roman', serif !important;
        font-size: 12pt !important;
        padding: 5px 8px !important;
      }
      #print-header, #print-footer {
        visibility: visible;
        page-break-after: avoid;
      }
      #chart-container {
        display: none;
      }
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      #sidebar-container {
        display: none;
      }
      #main-content {
        padding: 1rem;
      }
      table, th, td {
        font-size: 0.9rem;
      }
      #chart-container {
        max-width: 100%;
      }
    }

  </style>
</head>
<body>

  <div id="sidebar-container"></div>

  <div id="main-content">
    <h1><i class="fa fa-chart-pie"></i> Wastani wa Masomo na Mgawanyo wa Gredi</h1>

    <div class="filters">
      <select id="classSelect">
        <option value="">-- Chagua Darasa --</option>
      </select>

      <select id="termSelect">
        <option value="">-- Chagua Kipindi --</option>
        <option value="MTIHANI NUSU MUHULA 1">MTIHANI NUSU MUHULA 1</option>
        <option value="MTIHANI KUMALIZA MUHULA 1">MTIHANI KUMALIZA MUHULA 1</option>
        <option value="MTIHANI NUSU MUHULA 2">MTIHANI NUSU MUHULA 2</option>
        <option value="MTIHANI KUMALIZA MUHULA 2">MTIHANI KUMALIZA MUHULA 2</option>
        <option value="MID TERM 1 EXAMINATION">MID TERM 1 EXAMINATION</option>
        <option value="TERMINAL EXAMINATION">TERMINAL EXAMINATION</option>
        <option value="MID TERM 2 EXAMINATION">MID TERM 2 EXAMINATION</option>
        <option value="ANNUAL EXAMINATION">ANNUAL EXAMINATION</option>
      </select>
    </div>

    <button id="printBtn" disabled><i class="fa fa-print"></i> Chapisha Matokeo</button>

    <div id="loader">
      <div class="spinner"></div> Tafadhali subiri...
    </div>

    <div id="print-area" style="flex: 1; display: flex; flex-direction: column;">
      <div id="print-header" aria-live="polite" aria-atomic="true"></div>

      <table id="resultsTable" aria-describedby="print-header"></table>

      <div id="chart-container">
        <canvas id="gradePieChart" aria-label="Pie chart ya mgawanyo wa Gredi" role="img"></canvas>
      </div>

      <div id="print-footer">
        Prepared by SmartResultSystem â€“ Page <span class="page-number"></span>
      </div>
    </div>
  </div>

  <div id="footer-container"></div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
    import {
      getFirestore, collection, query, where, getDocs, getDoc, doc
    } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCJrWJouAt8xDPm5zOTOw1EcpNd997flQ8",
      authDomain: "smartresult-6c09c.firebaseapp.com",
      projectId: "smartresult-6c09c"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const classSelect = document.getElementById('classSelect');
    const termSelect = document.getElementById('termSelect');
    const resultsTable = document.getElementById('resultsTable');
    const printHeader = document.getElementById('print-header');
    const printFooter = document.getElementById('print-footer');
    const printBtn = document.getElementById('printBtn');
    const loader = document.getElementById('loader');

    let currentSchoolId = "";
    let schoolName = "";
    let gradeChart = null;

    // Grades function
    function getGrade(avg) {
      if (avg >= 81) return "A";
      if (avg >= 61) return "B";
      if (avg >= 41) return "C";
      if (avg >= 31) return "D";
      return "F";
    }

    function gradeClass(g) {
      return {
        "A": "grade-A",
        "B": "grade-B",
        "C": "grade-C",
        "D": "grade-D",
        "F": "grade-F"
      }[g] || "";
    }

    function showLoader(show) {
      if (show) {
        loader.classList.add('active');
        printBtn.disabled = true;
        classSelect.disabled = true;
        termSelect.disabled = true;
      } else {
        loader.classList.remove('active');
        printBtn.disabled = false;
        classSelect.disabled = false;
        termSelect.disabled = false;
      }
    }

    async function loadSchoolName() {
      if (!currentSchoolId) return;
      const schoolDoc = await getDoc(doc(db, "schools", currentSchoolId));
      if (schoolDoc.exists()) {
        schoolName = schoolDoc.data().name || "";
      }
    }

    async function loadClasses() {
      const q = query(collection(db, "classes"), where("schoolId", "==", currentSchoolId));
      const snapshot = await getDocs(q);
      classSelect.innerHTML = `<option value="">-- Chagua Darasa --</option>`;
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const opt = document.createElement('option');
        opt.value = docSnap.id;
        opt.textContent = data.name;
        classSelect.appendChild(opt);
      });
    }

    async function loadSubjects(classId) {
      const q = query(collection(db, "subjects"), where("schoolId", "==", currentSchoolId), where("classId", "==", classId));
      const snapshot = await getDocs(q);
      const subjects = [];
      snapshot.forEach(doc => {
        subjects.push({ id: doc.id, name: doc.data().name });
      });
      // Sort by name length asc
      subjects.sort((a, b) => a.name.length - b.name.length);
      return subjects;
    }

    // Get average per subject in the class for the term
    async function loadSubjectAverages(classId, term) {
      if (!classId || !term) return [];

      const subjects = await loadSubjects(classId);
      if (!subjects.length) return [];

      const averages = [];

      for (const subject of subjects) {
        // Get results where schoolId, classId, term match, and subject score exists
        const resultsQ = query(
          collection(db, "results"),
          where("schoolId", "==", currentSchoolId),
          where("classId", "==", classId),
          where("term", "==", term)
        );
        const snapshot = await getDocs(resultsQ);

        let total = 0;
        let count = 0;

        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          const score = data.results?.[subject.id];
          if (score !== undefined && score !== null && score !== '') {
            total += score;
            count++;
          }
        });

        const avg = count ? total / count : 0;
        const grade = getGrade(avg);
        averages.push({ id: subject.id, name: subject.name, avg, grade });
      }
      return averages;
    }

    function renderGradePieChart(subjectAverages) {
      const ctx = document.getElementById('gradePieChart').getContext('2d');
      // Count grades
      const counts = { A:0, B:0, C:0, D:0, F:0 };
      subjectAverages.forEach(sa => {
        if (counts[sa.grade] !== undefined) counts[sa.grade]++;
      });
      const data = {
        labels: ['A', 'B', 'C', 'D', 'F'],
        datasets: [{
          label: 'Mgawanyo wa Gredi',
          data: [counts.A, counts.B, counts.C, counts.D, counts.F],
          backgroundColor: [
            '#4caf50', // green
            '#2196f3', // blue
            '#ffeb3b', // yellow
            '#ff9800', // orange
            '#f44336', // red
          ],
          hoverOffset: 20
        }]
      };

      if (gradeChart) {
        gradeChart.destroy();
      }
      gradeChart = new Chart(ctx, {
        type: 'pie',
        data: data,
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'bottom',
              labels: { font: { size: 14 } }
            },
            tooltip: {
              callbacks: {
                label: ctx => ` ${ctx.label}: ${ctx.parsed} somo(s)`
              }
            }
          }
        }
      });
    }

    function renderTable(subjectAverages, className, term) {
      if (!subjectAverages.length) {
        resultsTable.innerHTML = '<tr><td colspan="3">Hakuna data kwa darasa hili na kipindi hiki.</td></tr>';
        printHeader.innerHTML = "";
        if(gradeChart) {
          gradeChart.destroy();
          gradeChart = null;
        }
        printBtn.disabled = true;
        return;
      }

      printHeader.innerHTML = `
        <div><strong>Jina la Shule:</strong> ${schoolName}</div>
        <div><strong>Darasa:</strong> ${className}</div>
        <div><strong>Kipindi:</strong> ${term}</div>
        <div><strong>Mwaka:</strong> ${new Date().getFullYear()}</div>
      `;

      let html = `
        <tr>
          <th class="subject-name">Somo</th>
          <th>Wastani</th>
          <th>Gredi</th>
        </tr>
      `;

      subjectAverages.forEach(subj => {
        html += `
          <tr class="${gradeClass(subj.grade)}">
            <td class="subject-name">${subj.name}</td>
            <td>${subj.avg.toFixed(1)}</td>
            <td>${subj.grade}</td>
          </tr>
        `;
      });

      resultsTable.innerHTML = html;
      printBtn.disabled = false;

      renderGradePieChart(subjectAverages);
    }

    // Load sidebar and footer content
    function loadIncludes() {
      fetch('sidebar.html')
        .then(res => res.text())
        .then(html => {
          document.getElementById('sidebar-container').innerHTML = html;
        });
      fetch('footer.html')
        .then(res => res.text())
        .then(html => {
          document.getElementById('footer-container').innerHTML = html;
        });
    }

    // Main load function
    async function loadPage() {
      showLoader(true);
      await loadSchoolName();
      await loadClasses();
      showLoader(false);
    }

    // On auth change
    onAuthStateChanged(auth, async user => {
      if (!user) {
        window.location.href = 'index.html';
        return;
      }
      const userDoc = await getDoc(doc(db, 'users', user.uid));
      if (userDoc.exists()) {
        currentSchoolId = userDoc.data().schoolId || "";
        await loadPage();
      }
    });

    // Event listeners
    classSelect.addEventListener('change', async () => {
      if (!classSelect.value || !termSelect.value) {
        resultsTable.innerHTML = "";
        printHeader.innerHTML = "";
        printBtn.disabled = true;
        if (gradeChart) {
          gradeChart.destroy();
          gradeChart = null;
        }
        return;
      }
      showLoader(true);
      const averages = await loadSubjectAverages(classSelect.value, termSelect.value);
      const selectedClassName = classSelect.options[classSelect.selectedIndex].text;
      const selectedTerm = termSelect.value;
      renderTable(averages, selectedClassName, selectedTerm);
      showLoader(false);
    });

    termSelect.addEventListener('change', async () => {
      if (!classSelect.value || !termSelect.value) {
        resultsTable.innerHTML = "";
        printHeader.innerHTML = "";
        printBtn.disabled = true;
        if (gradeChart) {
          gradeChart.destroy();
          gradeChart = null;
        }
        return;
      }
      showLoader(true);
      const averages = await loadSubjectAverages(classSelect.value, termSelect.value);
      const selectedClassName = classSelect.options[classSelect.selectedIndex].text;
      const selectedTerm = termSelect.value;
      renderTable(averages, selectedClassName, selectedTerm);
      showLoader(false);
    });

    printBtn.addEventListener('click', () => {
      window.print();
    });

    loadIncludes();
  </script>
</body>
</html>
