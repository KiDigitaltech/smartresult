<!DOCTYPE html>
<html lang="sw">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sajili Wanafunzi - SmartResult</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f0f4f8;
      display: flex;
      min-height: 100vh;
      flex-direction: column;
    }
    #sidebar, #header, #footer { width: 100%; }
    main {
      flex-grow: 1;
      padding: 2rem;
      max-width: 900px;
      margin: auto;
    }
    form {
      background: white;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      margin-bottom: 2rem;
    }
    h2 {
      color: #007bff;
      margin-bottom: 1.5rem;
      text-align: center;
    }
    label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
    }
    input, select {
      width: 100%;
      padding: 10px 14px;
      margin-bottom: 1.2rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1rem;
    }
    input:focus, select:focus {
      border-color: #007bff;
      outline: none;
      box-shadow: 0 0 5px rgba(0,123,255,0.5);
    }
    button {
      background: #007bff;
      color: white;
      font-weight: 700;
      border: none;
      cursor: pointer;
      padding: 12px 20px;
      border-radius: 6px;
      width: 100%;
      font-size: 1.1rem;
      transition: background 0.3s;
    }
    button:hover {
      background: #0056b3;
    }
    #msg, #uploadMsg {
      text-align: center;
      margin-top: 1rem;
      font-weight: 600;
      min-height: 1.5em;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    th, td {
      padding: 12px 15px;
      border-bottom: 1px solid #ddd;
      text-align: left;
    }
    th {
      background-color: #007bff;
      color: white;
      font-weight: 600;
    }
    tr:hover {
      background-color: #f1f5f9;
    }
    .actions i {
      margin-right: 10px;
      cursor: pointer;
      color: #007bff;
    }
    .actions i.delete { color: #dc3545; }
    .actions i:hover { color: #0056b3; }
    .actions i.delete:hover { color: #a71d2a; }
    #popupMessage {
      position: fixed;
      top: 20px;
      right: 20px;
      min-width: 250px;
      max-width: 320px;
      padding: 15px 20px;
      border-radius: 8px;
      color: white;
      font-weight: 600;
      font-size: 15px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      opacity: 0;
      pointer-events: none;
      transform: translateY(-20px);
      transition: opacity 0.3s ease, transform 0.3s ease;
      z-index: 10001;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    #popupMessage.show {
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0);
    }
    #popupMessage.success { background-color: #28a745; }
    #popupMessage.error { background-color: #dc3545; }
    #popupMessage.info { background-color: #17a2b8; }
    #popupMessage.warning {
      background-color: #ffc107;
      color: #212529;
    }
    #popupMessage .closeBtn {
      margin-left: auto;
      cursor: pointer;
      font-weight: bold;
      font-size: 18px;
    }
  </style>
</head>
<body>

<div id="header"></div>
<div style="display: flex; flex-grow: 1;">
  <div id="sidebar" style="flex-shrink:0; width:220px;"></div>

  <main>
    <h2>Sajili Mwanafunzi Mpya</h2>
    <form id="studentForm">
      <label for="studentName">Jina Kamili</label>
      <input type="text" id="studentName" placeholder="Jina la mwanafunzi" required />

      <label for="gender">Jinsia</label>
      <select id="gender" required>
        <option value="">-- Chagua jinsia --</option>
        <option value="Me">Me</option>
        <option value="Ke">Ke</option>
      </select>

      <label for="classSelect">Darasa</label>
      <select id="classSelect" required>
        <option value="">-- Chagua darasa --</option>
      </select>

      <button type="submit"><i class="fa-solid fa-plus"></i> Sajili</button>
      <p id="msg"></p>
    </form>

    <hr style="margin:2rem 0;" />

    <h2>Sajili Kupitia Excel</h2>
    <form id="uploadForm">
      <input type="file" id="excelFile" accept=".xls,.xlsx" required />
      <button type="submit"><i class="fa-solid fa-file-import"></i> Pakia Excel</button>
      <p id="uploadMsg"></p>
    </form>

    <h2>Orodha ya Wanafunzi</h2>
    <label for="filterClass">Chuja kwa Darasa</label>
    <select id="filterClass">
      <option value="">-- Chagua darasa --</option>
    </select>

    <table id="studentsTable" style="margin-top:1rem;">
      <thead>
        <tr>
          <th>Jina Kamili</th>
          <th>Jinsia</th>
          <th>Darasa</th>
          <th>Vitendo</th>
        </tr>
      </thead>
      <tbody>
        <!-- Data here -->
      </tbody>
    </table>
  </main>
</div>
<div id="footer"></div>

<!-- Popup -->
<div id="popupMessage">
  <i class="icon"></i>
  <span id="popupText"></span>
  <span class="closeBtn" title="Funga">&times;</span>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
import {
  getAuth, onAuthStateChanged, signOut
} from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
import {
  getFirestore, collection, addDoc, getDoc, getDocs, doc, query, where, deleteDoc
} from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

// Load UI parts
["header", "sidebar", "footer"].forEach(id => {
  fetch(`${id}.html`)
    .then(res => res.text())
    .then(html => document.getElementById(id).innerHTML = html);
});

// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyCJrWJouAt8xDPm5zOTOw1EcpNd997flQ8",
  authDomain: "smartresult-6c09c.firebaseapp.com",
  projectId: "smartresult-6c09c",
};
const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore(app);

// Element refs
const classSelect = document.getElementById("classSelect");
const filterClass = document.getElementById("filterClass");
const studentForm = document.getElementById("studentForm");
const studentsTableBody = document.querySelector("#studentsTable tbody");
const popup = document.getElementById("popupMessage");
const popupText = document.getElementById("popupText");
const popupClose = popup.querySelector(".closeBtn");
let schoolId = "";
let classesMap = {};

function showPopup(msg, type = "info") {
  popupText.textContent = msg;
  popup.className = `show ${type}`;
  clearTimeout(popup._timeout);
  popup._timeout = setTimeout(() => popup.classList.remove("show"), 4000);
}
popupClose.onclick = () => popup.classList.remove("show");

// Auth
onAuthStateChanged(auth, async user => {
  if (!user) return location.href = "login.html";
  const userDoc = await getDoc(doc(db, "users", user.uid));
  if (!userDoc.exists()) return alert("Hakuna taarifa.");
  schoolId = userDoc.data().schoolId;
  await loadClasses();
  await loadStudents();
});

async function loadClasses() {
  classSelect.innerHTML = '<option value="">-- Chagua darasa --</option>';
  filterClass.innerHTML = '<option value="">-- Chagua darasa --</option>';
  const q = query(collection(db, "classes"), where("schoolId", "==", schoolId));
  const snap = await getDocs(q);
  snap.forEach(doc => {
    const c = doc.data();
    classesMap[doc.id] = c.name;
    const opt = `<option value="${doc.id}">${c.name}</option>`;
    classSelect.innerHTML += opt;
    filterClass.innerHTML += opt;
  });
}

async function loadStudents(classId = "") {
  studentsTableBody.innerHTML = "";
  let q = query(collection(db, "students"), where("schoolId", "==", schoolId));
  if (classId) q = query(q, where("classId", "==", classId));
  const snap = await getDocs(q);
  if (snap.empty) {
    studentsTableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Hakuna mwanafunzi</td></tr>';
    return;
  }
  snap.forEach(doc => {
    const s = doc.data();
    studentsTableBody.innerHTML += `
      <tr>
        <td>${s.name}</td>
        <td>${s.gender}</td>
        <td>${classesMap[s.classId] || "-"}</td>
        <td class="actions">
          <i class="fa fa-trash delete" title="Futa" onclick="deleteStudent('${doc.id}')"></i>
        </td>
      </tr>`;
  });
}

window.deleteStudent = async function(id) {
  if (!confirm("Futa mwanafunzi huyu?")) return;
  await deleteDoc(doc(db, "students", id));
  showPopup("Mwanafunzi amefutwa", "success");
  loadStudents(filterClass.value);
};

studentForm.addEventListener("submit", async e => {
  e.preventDefault();
  const name = document.getElementById("studentName").value.trim();
  const gender = document.getElementById("gender").value;
  const classId = classSelect.value;
  if (!name || !gender || !classId) return showPopup("Jaza taarifa zote", "warning");

  const exists = await getDocs(query(
    collection(db, "students"),
    where("schoolId", "==", schoolId),
    where("name", "==", name),
    where("classId", "==", classId)
  ));
  if (!exists.empty) return showPopup("Mwanafunzi tayari yupo", "error");

  await addDoc(collection(db, "students"), {
    name, gender, classId, schoolId, createdAt: new Date()
  });
  showPopup("Mwanafunzi amesajiliwa", "success");
  studentForm.reset();
  loadStudents(filterClass.value);
});

document.getElementById("uploadForm").addEventListener("submit", async e => {
  e.preventDefault();
  const file = document.getElementById("excelFile").files[0];
  if (!file) return showPopup("Chagua faili", "warning");
  const reader = new FileReader();
  reader.onload = async e => {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: "array" });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(sheet);
    let added = 0, skipped = 0;

    for (const row of rows) {
      const name = row.name?.trim();
      const gender = row.gender?.trim();
      const clsName = row.class?.trim().toLowerCase();
      const classId = Object.keys(classesMap).find(k => classesMap[k].toLowerCase() === clsName);
      if (!name || !gender || !classId) { skipped++; continue; }

      const exists = await getDocs(query(
        collection(db, "students"),
        where("schoolId", "==", schoolId),
        where("name", "==", name),
        where("classId", "==", classId)
      ));
      if (!exists.empty) { skipped++; continue; }

      await addDoc(collection(db, "students"), { name, gender, classId, schoolId, createdAt: new Date() });
      added++;
    }
    showPopup(`${added} wameongezwa, ${skipped} wamerukwa.`, "success");
    loadStudents(filterClass.value);
  };
  reader.readAsArrayBuffer(file);
});

filterClass.addEventListener("change", e => loadStudents(e.target.value));
</script>

</body>
</html>
